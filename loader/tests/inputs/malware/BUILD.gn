# Copyright (c) 2026 vivo Mobile Communication Co., Ltd.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#       http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

import("//build/toolchain/blueos.gni")

postlink_action("record_everything_path") {
  testonly = true
  exe = "//kernel/loader/tests/inputs/no_std_app:everyting"
  script = "//kernel/loader/tests/scripts/print_exe_abspath.py"
  outfile = "${target_gen_dir}/${target_name}"
  args = [ rebase_path(outfile) ]
  outputs = [ outfile ]
}

postlink_action("record_invalid_entry_bomb_path") {
  testonly = true
  exe = "//kernel/loader/tests/inputs/malware/bombs:invalid_entry(//build/toolchain:host)"
  script = "//kernel/loader/tests/scripts/print_exe_abspath.py"
  outfile = "${target_gen_dir}/${target_name}"
  args = [ rebase_path(outfile) ]
  outputs = [ outfile ]
}

action("gen_invalid_entry_elf") {
  deps = [
    ":record_everything_path",
    ":record_invalid_entry_bomb_path",
  ]
  testonly = true
  script = "//kernel/loader/tests/scripts/gen_bomb.py"
  outfile = "${target_gen_dir}/${target_name}"
  args = rebase_path(get_target_outputs(":record_invalid_entry_bomb_path")) +
         rebase_path(get_target_outputs(":record_everything_path")) +
         [ rebase_path(outfile) ]
  outputs = [ outfile ]
}

action("gen_invalid_entry_elf_path_symbol") {
  testonly = true
  script = "//kernel/loader/tests/scripts/gen_path_symbol.py"
  outfile = "${target_gen_dir}/${target_name}.c"
  deps = [ ":gen_invalid_entry_elf" ]
  args = rebase_path(get_target_outputs(":gen_invalid_entry_elf")) + [
           "INVALID_ENTRY_ELF_PATH",
           rebase_path(outfile),
         ]
  outputs = [ outfile ]
}

postlink_action("record_invalid_magic_bomb_path") {
  testonly = true
  exe = "//kernel/loader/tests/inputs/malware/bombs:invalid_magic(//build/toolchain:host)"
  script = "//kernel/loader/tests/scripts/print_exe_abspath.py"
  outfile = "${target_gen_dir}/${target_name}"
  args = [ rebase_path(outfile) ]
  outputs = [ outfile ]
}

action("gen_invalid_magic_elf") {
  deps = [
    ":record_everything_path",
    ":record_invalid_magic_bomb_path",
  ]
  testonly = true
  script = "//kernel/loader/tests/scripts/gen_bomb.py"
  outfile = "${target_gen_dir}/${target_name}"
  args = rebase_path(get_target_outputs(":record_invalid_magic_bomb_path")) +
         rebase_path(get_target_outputs(":record_everything_path")) +
         [ rebase_path(outfile) ]
  outputs = [ outfile ]
}

action("gen_invalid_magic_elf_path_symbol") {
  testonly = true
  script = "//kernel/loader/tests/scripts/gen_path_symbol.py"
  outfile = "${target_gen_dir}/${target_name}.c"
  deps = [ ":gen_invalid_magic_elf" ]
  args = rebase_path(get_target_outputs(":gen_invalid_magic_elf")) + [
           "INVALID_MAGIC_ELF_PATH",
           rebase_path(outfile),
         ]
  outputs = [ outfile ]
}

postlink_action("record_invalid_segment_size_bomb_path") {
  testonly = true
  exe = "//kernel/loader/tests/inputs/malware/bombs:invalid_segment_size(//build/toolchain:host)"
  script = "//kernel/loader/tests/scripts/print_exe_abspath.py"
  outfile = "${target_gen_dir}/${target_name}"
  args = [ rebase_path(outfile) ]
  outputs = [ outfile ]
}

action("gen_invalid_segment_size_elf") {
  deps = [
    ":record_everything_path",
    ":record_invalid_segment_size_bomb_path",
  ]
  testonly = true
  script = "//kernel/loader/tests/scripts/gen_bomb.py"
  outfile = "${target_gen_dir}/${target_name}"
  args = rebase_path(
             get_target_outputs(":record_invalid_segment_size_bomb_path")) +
         rebase_path(get_target_outputs(":record_everything_path")) +
         [ rebase_path(outfile) ]
  outputs = [ outfile ]
}

action("gen_invalid_segment_size_elf_path_symbol") {
  testonly = true
  script = "//kernel/loader/tests/scripts/gen_path_symbol.py"
  outfile = "${target_gen_dir}/${target_name}.c"
  deps = [ ":gen_invalid_segment_size_elf" ]
  args = rebase_path(get_target_outputs(":gen_invalid_segment_size_elf")) + [
           "INVALID_SEGMENT_SIZE_ELF_PATH",
           rebase_path(outfile),
         ]
  outputs = [ outfile ]
}

static_library("bomb_path") {
  testonly = true
  deps = [
    ":gen_invalid_entry_elf_path_symbol",
    ":gen_invalid_magic_elf_path_symbol",
    ":gen_invalid_segment_size_elf_path_symbol",
  ]
  sources = get_target_outputs(":gen_invalid_entry_elf_path_symbol") +
            get_target_outputs(":gen_invalid_magic_elf_path_symbol") +
            get_target_outputs(":gen_invalid_segment_size_elf_path_symbol")
}
